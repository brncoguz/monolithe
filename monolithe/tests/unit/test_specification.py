# -*- coding: utf-8 -*-

import json
from unittest import TestCase
from monolithe.specifications import Specification

SPEC = """{
    "resource_name": "tasks",
    "description": "Represent a task to do in a list",
    "entity_name": "TheTask",
    "package": "todo-list",
    "get": true,
    "update": true,
    "delete": true,
    "rest_name": "task",
    "extends": [
        "@description",
        "@title"
    ],
    "attributes": {
        "status": {
            "min_length": 1,
            "exposed": true,
            "filterable": true,
            "unique_scope": "no",
            "allowed_choices": [
                "TODO",
                "DONE"
            ],
            "max_length": 2048,
            "orderable": true,
            "type": "enum",
            "description": "The status of the task"
        },
        "theTime": {
            "allowed_chars": "123",
            "allowed_choices": null,
            "autogenerated": true,
            "channel": "rest",
            "creation_only": true,
            "default_order": true,
            "default_value": "123",
            "description": "the time",
            "exposed": false,
            "filterable": false,
            "format": null,
            "max_length": 1,
            "max_value": 2,
            "min_length": 3,
            "min_value": 4,
            "orderable": false,
            "read_only": true,
            "transient": true,
            "type": "time",
            "unique": true,
            "unique_scope": "global"
        }
    },
    "children": [
        {
            "specification": "user",
            "relationship": "member",
            "update": true,
            "get": true
        },
        {
            "specification": "toto",
            "relationship": "child",
            "create": true,
            "get": true
        }

    ]
}
"""

class SpecificationTest(TestCase):
    """ Test for specifications

    """

    def _verify(self, s, data):
        """
        """
        self.assertEquals(s.rest_name, data['rest_name'])
        self.assertEquals(s.description, data['description'])
        self.assertEquals(s.entity_name, 'TheTask')
        self.assertEquals(s.package, 'todo-list')
        self.assertEquals(s.instance_name, 'the_task')
        self.assertEquals(s.instance_name_plural, 'the_tasks')
        self.assertEquals(s.resource_name, 'tasks')
        self.assertEquals(s.extends, ["@description", "@title"])
        self.assertTrue(s.allows_get)
        self.assertFalse(s.allows_create)
        self.assertTrue(s.allows_update)
        self.assertTrue(s.allows_delete)
        self.assertFalse(s.is_root)
        self.assertTrue(s.has_time_attribute)

        self.assertEquals(len(s.attributes), 2)
        self.assertEquals(s.attributes[0].allowed_chars, None)
        self.assertEquals(s.attributes[0].allowed_choices, ["TODO", "DONE"])
        self.assertEquals(s.attributes[0].autogenerated, False)
        self.assertEquals(s.attributes[0].channel, None)
        self.assertEquals(s.attributes[0].creation_only, False)
        self.assertEquals(s.attributes[0].default_order, False)
        self.assertEquals(s.attributes[0].default_value, None)
        self.assertEquals(s.attributes[0].description, 'The status of the task')
        self.assertEquals(s.attributes[0].exposed, True)
        self.assertEquals(s.attributes[0].filterable, True)
        self.assertEquals(s.attributes[0].format, 'free')
        self.assertEquals(s.attributes[0].local_type, 'str')
        self.assertEquals(s.attributes[0].max_length, 2048)
        self.assertEquals(s.attributes[0].max_value, None)
        self.assertEquals(s.attributes[0].min_length, 1)
        self.assertEquals(s.attributes[0].min_value, None)
        self.assertEquals(s.attributes[0].orderable, True)
        self.assertEquals(s.attributes[0].read_only, False)
        self.assertEquals(s.attributes[0].rest_name, 'status')
        self.assertEquals(s.attributes[0].transient, False)
        self.assertEquals(s.attributes[0].type, 'enum')
        self.assertEquals(s.attributes[0].unique, False)
        self.assertEquals(s.attributes[0].unique_scope, 'no')

        self.assertEquals(s.attributes[1].allowed_chars, '123')
        self.assertEquals(s.attributes[1].allowed_choices, None)
        self.assertEquals(s.attributes[1].autogenerated, True)
        self.assertEquals(s.attributes[1].channel, 'rest')
        self.assertEquals(s.attributes[1].creation_only, True)
        self.assertEquals(s.attributes[1].default_order, True)
        self.assertEquals(s.attributes[1].default_value, '123')
        self.assertEquals(s.attributes[1].description, 'the time')
        self.assertEquals(s.attributes[1].exposed, False)
        self.assertEquals(s.attributes[1].filterable, False)
        self.assertEquals(s.attributes[1].format, None)
        self.assertEquals(s.attributes[1].local_type, 'time')
        self.assertEquals(s.attributes[1].max_length, 1)
        self.assertEquals(s.attributes[1].max_value, 2)
        self.assertEquals(s.attributes[1].min_length, 3)
        self.assertEquals(s.attributes[1].min_value, 4)
        self.assertEquals(s.attributes[1].orderable, False)
        self.assertEquals(s.attributes[1].read_only, True)
        self.assertEquals(s.attributes[1].rest_name, 'theTime')
        self.assertEquals(s.attributes[1].local_name, 'the_time')
        self.assertEquals(s.attributes[1].transient, True)
        self.assertEquals(s.attributes[1].type, 'time')
        self.assertEquals(s.attributes[1].unique, True)
        self.assertEquals(s.attributes[1].unique_scope, 'global')


        self.assertEquals(len(s.child_apis), 2)
        self.assertEquals(s.child_apis[0].specification, 'user')
        self.assertEquals(s.child_apis[0].relationship, 'member')
        self.assertFalse(s.child_apis[0].allows_create)
        self.assertTrue(s.child_apis[0].allows_update)
        self.assertFalse(s.child_apis[0].allows_delete)
        self.assertTrue(s.child_apis[0].allows_get)

        self.assertEquals(s.child_apis[1].specification, 'toto')
        self.assertEquals(s.child_apis[1].relationship, 'child')
        self.assertTrue(s.child_apis[1].allows_create)
        self.assertFalse(s.child_apis[1].allows_update)
        self.assertFalse(s.child_apis[1].allows_delete)
        self.assertTrue(s.child_apis[1].allows_get)

    def test_specification_from_dict(self):
        """ Convert REST names to Python

        """
        data = json.loads(SPEC)
        s = Specification("task.spec")
        s.from_dict(data)
        self._verify(s, data)


    def test_specification_to_dict(self):
        """
        """
        data = json.loads(SPEC)
        s = Specification("task.spec")
        s.from_dict(data)
        data = s.to_dict()
        self._verify(s, data)